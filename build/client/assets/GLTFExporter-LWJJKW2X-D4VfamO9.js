import{p as Q,r as J,C as F,s as ee,x as N,t as te,v as z,w as se,R as re,z as P,B as ne,D as ie,G as O,H as ae,K as V,T as oe,$ as le,U as ce,X as ue,W as he,Z as pe,_ as me,a0 as fe,a1 as de,a2 as ge,a3 as ye,a4 as xe}from"./index-CTgVHcLT.js";import"./chunk-UIGDSWPH-74DChMva.js";import"./index-Boai_r5o.js";le();var j={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]},G=class{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new Se(e)}),this.register(function(e){return new _e(e)}),this.register(function(e){return new Ce(e)}),this.register(function(e){return new Fe(e)}),this.register(function(e){return new Oe(e)}),this.register(function(e){return new ke(e)}),this.register(function(e){return new Le(e)}),this.register(function(e){return new Ue(e)}),this.register(function(e){return new ve(e)}),this.register(function(e){return new ze(e)}),this.register(function(e){return new De(e)}),this.register(function(e){return new Be(e)}),this.register(function(e){return new Pe(e)}),this.register(function(e){return new Ge(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,r,s){let n=new Ne,i=[];for(let a=0,o=this.pluginCallbacks.length;a<o;a++)i.push(this.pluginCallbacks[a](n));n.setPlugins(i),n.setTextureUtils(this.textureUtils),n.writeAsync(e,t,s).catch(r)}parseAsync(e,t){let r=this;return new Promise(function(s,n){r.parse(e,s,n,t)})}},g={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},D="KHR_mesh_quantization",b={};b[ce]=g.NEAREST;b[ue]=g.NEAREST_MIPMAP_NEAREST;b[he]=g.NEAREST_MIPMAP_LINEAR;b[pe]=g.LINEAR;b[me]=g.LINEAR_MIPMAP_NEAREST;b[fe]=g.LINEAR_MIPMAP_LINEAR;b[de]=g.CLAMP_TO_EDGE;b[ge]=g.REPEAT;b[ye]=g.MIRRORED_REPEAT;var Y={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Te=new Q,K=12,we=1179937895,Ae=2,X=8,Me=1313821514,be=5130562;function v(e,t){return e.length===t.length&&e.every(function(r,s){return r===t[s]})}function Ee(e){return new TextEncoder().encode(e).buffer}function Ie(e){return v(e.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Re(e,t,r){let s={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=t;n<t+r;n++)for(let i=0;i<e.itemSize;i++){let a;e.itemSize>4?a=e.array[n*e.itemSize+i]:(i===0?a=e.getX(n):i===1?a=e.getY(n):i===2?a=e.getZ(n):i===3&&(a=e.getW(n)),e.normalized===!0&&(a=P.normalize(a,e.array))),s.min[i]=Math.min(s.min[i],a),s.max[i]=Math.max(s.max[i],a)}return s}function Z(e){return Math.ceil(e/4)*4}function B(e,t=0){let r=Z(e.byteLength);if(r!==e.byteLength){let s=new Uint8Array(r);if(s.set(new Uint8Array(e)),t!==0)for(let n=e.byteLength;n<r;n++)s[n]=t;return s.buffer}return e}function q(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function W(e,t){if(e.toBlob!==void 0)return new Promise(s=>e.toBlob(s,t));let r;return t==="image/jpeg"?r=.92:t==="image/webp"&&(r=.8),e.convertToBlob({type:t,quality:r})}var Ne=class{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+te}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,r={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let s=this,n=s.buffers,i=s.json;r=s.options;let a=s.extensionsUsed,o=s.extensionsRequired,l=new Blob(n,{type:"application/octet-stream"}),p=Object.keys(a),u=Object.keys(o);if(p.length>0&&(i.extensionsUsed=p),u.length>0&&(i.extensionsRequired=u),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=l.size),r.binary===!0){let m=new FileReader;m.readAsArrayBuffer(l),m.onloadend=function(){let c=B(m.result),h=new DataView(new ArrayBuffer(X));h.setUint32(0,c.byteLength,!0),h.setUint32(4,be,!0);let d=B(Ee(JSON.stringify(i)),32),x=new DataView(new ArrayBuffer(X));x.setUint32(0,d.byteLength,!0),x.setUint32(4,Me,!0);let w=new ArrayBuffer(K),E=new DataView(w);E.setUint32(0,we,!0),E.setUint32(4,Ae,!0);let C=K+x.byteLength+d.byteLength+h.byteLength+c.byteLength;E.setUint32(8,C,!0);let f=new Blob([w,x,d,h,c],{type:"application/octet-stream"}),y=new FileReader;y.readAsArrayBuffer(f),y.onloadend=function(){t(y.result)}}}else if(i.buffers&&i.buffers.length>0){let m=new FileReader;m.readAsDataURL(l),m.onloadend=function(){let c=m.result;i.buffers[0].uri=c,t(i)}}else t(i)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;let r=this.options,s=this.extensionsUsed;try{let n=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&n.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(let i in n.gltfExtensions)t.extensions[i]=n.gltfExtensions[i],s[i]=!0;delete n.gltfExtensions}Object.keys(n).length>0&&(t.extras=n)}catch(n){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+n.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){let r=new Map;r.set(!0,this.uid++),r.set(!1,this.uid++),this.uids.set(e,r)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new F;for(let r=0,s=e.count;r<s;r++)if(Math.abs(t.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let r=e.clone(),s=new F;for(let n=0,i=r.count;n<i;n++)s.fromBufferAttribute(r,n),s.x===0&&s.y===0&&s.z===0?s.setX(1):s.normalize(),r.setXYZ(n,s.x,s.y,s.z);return t.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let r=!1,s={};(t.offset.x!==0||t.offset.y!==0)&&(s.offset=t.offset.toArray(),r=!0),t.rotation!==0&&(s.rotation=t.rotation,r=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(s.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=s,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function r(m){return m.colorSpace===oe?function(c){return c<.04045?c*.0773993808:Math.pow(c*.9478672986+.0521327014,2.4)}:function(c){return c}}e instanceof z&&(e=await this.decompressTextureAsync(e)),t instanceof z&&(t=await this.decompressTextureAsync(t));let s=e?e.image:null,n=t?t.image:null,i=Math.max(s?s.width:0,n?n.width:0),a=Math.max(s?s.height:0,n?n.height:0),o=q();o.width=i,o.height=a;let l=o.getContext("2d",{willReadFrequently:!0});l.fillStyle="#00ffff",l.fillRect(0,0,i,a);let p=l.getImageData(0,0,i,a);if(s){l.drawImage(s,0,0,i,a);let m=r(e),c=l.getImageData(0,0,i,a).data;for(let h=2;h<c.length;h+=4)p.data[h]=m(c[h]/256)*256}if(n){l.drawImage(n,0,0,i,a);let m=r(t),c=l.getImageData(0,0,i,a).data;for(let h=1;h<c.length;h+=4)p.data[h]=m(c[h]/256)*256}l.putImageData(p,0,0);let u=(e||t).clone();return u.source=new se(o),u.colorSpace=re,u.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),u}async decompressTextureAsync(e,t=1/0){if(this.textureUtils===null)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0}processBufferView(e,t,r,s,n){let i=this.json;i.bufferViews||(i.bufferViews=[]);let a;switch(t){case g.BYTE:case g.UNSIGNED_BYTE:a=1;break;case g.SHORT:case g.UNSIGNED_SHORT:a=2;break;default:a=4}let o=e.itemSize*a;n===g.ARRAY_BUFFER&&(o=Math.ceil(o/4)*4);let l=Z(s*o),p=new DataView(new ArrayBuffer(l)),u=0;for(let c=r;c<r+s;c++){for(let h=0;h<e.itemSize;h++){let d;e.itemSize>4?d=e.array[c*e.itemSize+h]:(h===0?d=e.getX(c):h===1?d=e.getY(c):h===2?d=e.getZ(c):h===3&&(d=e.getW(c)),e.normalized===!0&&(d=P.normalize(d,e.array))),t===g.FLOAT?p.setFloat32(u,d,!0):t===g.INT?p.setInt32(u,d,!0):t===g.UNSIGNED_INT?p.setUint32(u,d,!0):t===g.SHORT?p.setInt16(u,d,!0):t===g.UNSIGNED_SHORT?p.setUint16(u,d,!0):t===g.BYTE?p.setInt8(u,d):t===g.UNSIGNED_BYTE&&p.setUint8(u,d),u+=a}u%o!==0&&(u+=o-u%o)}let m={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:l};return n!==void 0&&(m.target=n),n===g.ARRAY_BUFFER&&(m.byteStride=o),this.byteOffset+=l,i.bufferViews.push(m),{id:i.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),new Promise(function(s){let n=new FileReader;n.readAsArrayBuffer(e),n.onloadend=function(){let i=B(n.result),a={buffer:t.processBuffer(i),byteOffset:t.byteOffset,byteLength:i.byteLength};t.byteOffset+=i.byteLength,s(r.bufferViews.push(a)-1)}})}processAccessor(e,t,r,s){let n=this.json,i={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"},a;if(e.array.constructor===Float32Array)a=g.FLOAT;else if(e.array.constructor===Int32Array)a=g.INT;else if(e.array.constructor===Uint32Array)a=g.UNSIGNED_INT;else if(e.array.constructor===Int16Array)a=g.SHORT;else if(e.array.constructor===Uint16Array)a=g.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)a=g.BYTE;else if(e.array.constructor===Uint8Array)a=g.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(r===void 0&&(r=0),(s===void 0||s===1/0)&&(s=e.count),s===0)return null;let o=Re(e,r,s),l;t!==void 0&&(l=e===t.index?g.ELEMENT_ARRAY_BUFFER:g.ARRAY_BUFFER);let p=this.processBufferView(e,a,r,s,l),u={bufferView:p.id,byteOffset:p.byteOffset,componentType:a,count:s,max:o.max,min:o.min,type:i[e.itemSize]};return e.normalized===!0&&(u.normalized=!0),n.accessors||(n.accessors=[]),n.accessors.push(u)-1}processImage(e,t,r,s="image/png"){if(e!==null){let n=this,i=n.cache,a=n.json,o=n.options,l=n.pending;i.images.has(e)||i.images.set(e,{});let p=i.images.get(e),u=s+":flipY/"+r.toString();if(p[u]!==void 0)return p[u];a.images||(a.images=[]);let m={mimeType:s},c=q();c.width=Math.min(e.width,o.maxTextureSize),c.height=Math.min(e.height,o.maxTextureSize);let h=c.getContext("2d",{willReadFrequently:!0});if(r===!0&&(h.translate(0,c.height),h.scale(1,-1)),e.data!==void 0){t!==ne&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let x=new Uint8ClampedArray(e.height*e.width*4);for(let w=0;w<x.length;w+=4)x[w+0]=e.data[w+0],x[w+1]=e.data[w+1],x[w+2]=e.data[w+2],x[w+3]=e.data[w+3];h.putImageData(new ImageData(x,e.width,e.height),0,0)}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)h.drawImage(e,0,0,c.width,c.height);else throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");o.binary===!0?l.push(W(c,s).then(x=>n.processBufferViewImage(x)).then(x=>{m.bufferView=x})):c.toDataURL!==void 0?m.uri=c.toDataURL(s):l.push(W(c,s).then(x=>new FileReader().readAsDataURL(x)).then(x=>{m.uri=x}));let d=a.images.push(m)-1;return p[u]=d,d}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let r={magFilter:b[e.magFilter],minFilter:b[e.minFilter],wrapS:b[e.wrapS],wrapT:b[e.wrapT]};return t.samplers.push(r)-1}async processTextureAsync(e){let t=this.options,r=this.cache,s=this.json;if(r.textures.has(e))return r.textures.get(e);s.textures||(s.textures=[]),e instanceof z&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let n=e.userData.mimeType;n==="image/webp"&&(n="image/png");let i={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,n)};e.name&&(i.name=e.name),await this._invokeAllAsync(async function(o){o.writeTexture&&await o.writeTexture(e,i)});let a=s.textures.push(i)-1;return r.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);let s={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let n=e.color.toArray().concat([e.opacity]);if(v(n,[1,1,1,1])||(s.pbrMetallicRoughness.baseColorFactor=n),e.isMeshStandardMaterial?(s.pbrMetallicRoughness.metallicFactor=e.metalness,s.pbrMetallicRoughness.roughnessFactor=e.roughness):(s.pbrMetallicRoughness.metallicFactor=0,s.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let a=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),o={index:await this.processTextureAsync(a),texCoord:a.channel};this.applyTextureTransform(o,a),s.pbrMetallicRoughness.metallicRoughnessTexture=o}if(e.map){let a={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(a,e.map),s.pbrMetallicRoughness.baseColorTexture=a}if(e.emissive){let a=e.emissive;if(Math.max(a.r,a.g,a.b)>0&&(s.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let o={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(o,e.emissiveMap),s.emissiveTexture=o}}if(e.normalMap){let a={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(a.scale=e.normalScale.x),this.applyTextureTransform(a,e.normalMap),s.normalTexture=a}if(e.aoMap){let a={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(a.strength=e.aoMapIntensity),this.applyTextureTransform(a,e.aoMap),s.occlusionTexture=a}e.transparent?s.alphaMode="BLEND":e.alphaTest>0&&(s.alphaMode="MASK",s.alphaCutoff=e.alphaTest),e.side===ie&&(s.doubleSided=!0),e.name!==""&&(s.name=e.name),this.serializeUserData(e,s),await this._invokeAllAsync(async function(a){a.writeMaterialAsync&&await a.writeMaterialAsync(e,s)});let i=r.materials.push(s)-1;return t.materials.set(e,i),i}async processMeshAsync(e){let t=this.cache,r=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let f=0,y=e.material.length;f<y;f++)s.push(e.material[f].uuid);else s.push(e.material.uuid);let n=s.join(":");if(t.meshes.has(n))return t.meshes.get(n);let i=e.geometry,a;e.isLineSegments?a=g.LINES:e.isLineLoop?a=g.LINE_LOOP:e.isLine?a=g.LINE_STRIP:e.isPoints?a=g.POINTS:a=e.material.wireframe?g.LINES:g.TRIANGLES;let o={},l={},p=[],u=[],m={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},c=i.getAttribute("normal");c!==void 0&&!this.isNormalizedNormalAttribute(c)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),i.setAttribute("normal",this.createNormalizedNormalAttribute(c)));let h=null;for(let f in i.attributes){if(f.slice(0,5)==="morph")continue;let y=i.attributes[f];if(f=m[f]||f.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(f)||(f="_"+f),t.attributes.has(this.getUID(y))){l[f]=t.attributes.get(this.getUID(y));continue}h=null;let T=y.array;f==="JOINTS_0"&&!(T instanceof Uint16Array)&&!(T instanceof Uint8Array)?(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),h=new N(new Uint16Array(T),y.itemSize,y.normalized)):(T instanceof Uint32Array||T instanceof Int32Array)&&!f.startsWith("_")&&(console.warn('GLTFExporter: Attribute "'.concat(f,'" converted to type FLOAT.')),h=G.Utils.toFloat32BufferAttribute(y));let A=this.processAccessor(h||y,i);A!==null&&(f.startsWith("_")||this.detectMeshQuantization(f,y),l[f]=A,t.attributes.set(this.getUID(y),A))}if(c!==void 0&&i.setAttribute("normal",c),Object.keys(l).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){let f=[],y=[],T={};if(e.morphTargetDictionary!==void 0)for(let A in e.morphTargetDictionary)T[e.morphTargetDictionary[A]]=A;for(let A=0;A<e.morphTargetInfluences.length;++A){let I={},H=!1;for(let _ in i.morphAttributes){if(_!=="position"&&_!=="normal"){H||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),H=!0);continue}let R=i.morphAttributes[_][A],k=_.toUpperCase(),L=i.attributes[_];if(t.attributes.has(this.getUID(R,!0))){I[k]=t.attributes.get(this.getUID(R,!0));continue}let U=R.clone();if(!i.morphTargetsRelative)for(let M=0,$=R.count;M<$;M++)for(let S=0;S<R.itemSize;S++)S===0&&U.setX(M,R.getX(M)-L.getX(M)),S===1&&U.setY(M,R.getY(M)-L.getY(M)),S===2&&U.setZ(M,R.getZ(M)-L.getZ(M)),S===3&&U.setW(M,R.getW(M)-L.getW(M));I[k]=this.processAccessor(U,i),t.attributes.set(this.getUID(L,!0),I[k])}u.push(I),f.push(e.morphTargetInfluences[A]),e.morphTargetDictionary!==void 0&&y.push(T[A])}o.weights=f,y.length>0&&(o.extras={},o.extras.targetNames=y)}let d=Array.isArray(e.material);if(d&&i.groups.length===0)return null;let x=!1;if(d&&i.index===null){let f=[];for(let y=0,T=i.attributes.position.count;y<T;y++)f[y]=y;i.setIndex(f),x=!0}let w=d?e.material:[e.material],E=d?i.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let f=0,y=E.length;f<y;f++){let T={mode:a,attributes:l};if(this.serializeUserData(i,T),u.length>0&&(T.targets=u),i.index!==null){let I=this.getUID(i.index);(E[f].start!==void 0||E[f].count!==void 0)&&(I+=":"+E[f].start+":"+E[f].count),t.attributes.has(I)?T.indices=t.attributes.get(I):(T.indices=this.processAccessor(i.index,i,E[f].start,E[f].count),t.attributes.set(I,T.indices)),T.indices===null&&delete T.indices}let A=await this.processMaterialAsync(w[E[f].materialIndex]);A!==null&&(T.material=A),p.push(T)}x===!0&&i.setIndex(null),o.primitives=p,r.meshes||(r.meshes=[]),await this._invokeAllAsync(function(f){f.writeMesh&&f.writeMesh(e,o)});let C=r.meshes.push(o)-1;return t.meshes.set(n,C),C}detectMeshQuantization(e,t){if(this.extensionsUsed[D])return;let r;switch(t.array.constructor){case Int8Array:r="byte";break;case Uint8Array:r="unsigned byte";break;case Int16Array:r="short";break;case Uint16Array:r="unsigned short";break;default:return}t.normalized&&(r+=" normalized");let s=e.split("_",1)[0];j[s]&&j[s].includes(r)&&(this.extensionsUsed[D]=!0,this.extensionsRequired[D]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let r=e.isOrthographicCamera,s={type:r?"orthographic":"perspective"};return r?s.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:s.perspective={aspectRatio:e.aspect,yfov:P.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(s.name=e.type),t.cameras.push(s)-1}processAnimation(e,t){let r=this.json,s=this.nodeMap;r.animations||(r.animations=[]),e=G.Utils.mergeMorphTargetTracks(e.clone(),t);let n=e.tracks,i=[],a=[];for(let o=0;o<n.length;++o){let l=n[o],p=O.parseTrackName(l.name),u=O.findNode(t,p.nodeName),m=Y[p.propertyName];if(p.objectName==="bones"&&(u.isSkinnedMesh===!0?u=u.skeleton.getBoneByName(p.objectIndex):u=void 0),!u||!m){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name);continue}let c=1,h=l.values.length/l.times.length;m===Y.morphTargetInfluences&&(h/=u.morphTargetInfluences.length);let d;l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(d="CUBICSPLINE",h/=3):l.getInterpolation()===ae?d="STEP":d="LINEAR",a.push({input:this.processAccessor(new N(l.times,c)),output:this.processAccessor(new N(l.values,h)),interpolation:d}),i.push({sampler:a.length-1,target:{node:s.get(u),path:m}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:a,channels:i}),r.animations.length-1}processSkin(e){let t=this.json,r=this.nodeMap,s=t.nodes[r.get(e)],n=e.skeleton;if(n===void 0)return null;let i=e.skeleton.bones[0];if(i===void 0)return null;let a=[],o=new Float32Array(n.bones.length*16),l=new J;for(let p=0;p<n.bones.length;++p)a.push(r.get(n.bones[p])),l.copy(n.boneInverses[p]),l.multiply(e.bindMatrix).toArray(o,p*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new N(o,16)),joints:a,skeleton:r.get(i)}),s.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,r=this.options,s=this.nodeMap;t.nodes||(t.nodes=[]);let n={};if(r.trs){let a=e.quaternion.toArray(),o=e.position.toArray(),l=e.scale.toArray();v(a,[0,0,0,1])||(n.rotation=a),v(o,[0,0,0])||(n.translation=o),v(l,[1,1,1])||(n.scale=l)}else e.matrixAutoUpdate&&e.updateMatrix(),Ie(e.matrix)===!1&&(n.matrix=e.matrix.elements);if(e.name!==""&&(n.name=String(e.name)),this.serializeUserData(e,n),e.isMesh||e.isLine||e.isPoints){let a=await this.processMeshAsync(e);a!==null&&(n.mesh=a)}else e.isCamera&&(n.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let a=[];for(let o=0,l=e.children.length;o<l;o++){let p=e.children[o];if(p.visible||r.onlyVisible===!1){let u=await this.processNodeAsync(p);u!==null&&a.push(u)}}a.length>0&&(n.children=a)}await this._invokeAllAsync(function(a){a.writeNode&&a.writeNode(e,n)});let i=t.nodes.push(n)-1;return s.set(e,i),i}async processSceneAsync(e){let t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);let s={};e.name!==""&&(s.name=e.name),t.scenes.push(s);let n=[];for(let i=0,a=e.children.length;i<a;i++){let o=e.children[i];if(o.visible||r.onlyVisible===!1){let l=await this.processNodeAsync(o);l!==null&&n.push(l)}}n.length>0&&(s.nodes=n),this.serializeUserData(e,s)}async processObjectsAsync(e){let t=new V;t.name="AuxScene";for(let r=0;r<e.length;r++)t.children.push(e[r]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(s){s.beforeParse&&s.beforeParse(e)});let r=[];for(let s=0;s<e.length;s++)e[s]instanceof V?await this.processSceneAsync(e[s]):r.push(e[s]);r.length>0&&await this.processObjectsAsync(r);for(let s=0;s<this.skins.length;++s)this.processSkin(this.skins[s]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);await this._invokeAllAsync(function(s){s.afterParse&&s.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,r=this.plugins.length;t<r;t++)await e(this.plugins[t])}},Se=class{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}let r=this.writer,s=r.json,n=r.extensionsUsed,i={};e.name&&(i.name=e.name),i.color=e.color.toArray(),i.intensity=e.intensity,e.isDirectionalLight?i.type="directional":e.isPointLight?(i.type="point",e.distance>0&&(i.range=e.distance)):e.isSpotLight&&(i.type="spot",e.distance>0&&(i.range=e.distance),i.spot={},i.spot.innerConeAngle=(1-e.penumbra)*e.angle,i.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),n[this.name]||(s.extensions=s.extensions||{},s.extensions[this.name]={lights:[]},n[this.name]=!0);let a=s.extensions[this.name].lights;a.push(i),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}},_e=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}},Le=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;let r=this.writer,s=r.extensionsUsed,n={};if(n.clearcoatFactor=e.clearcoat,e.clearcoatMap){let i={index:await r.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};r.applyTextureTransform(i,e.clearcoatMap),n.clearcoatTexture=i}if(n.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let i={index:await r.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};r.applyTextureTransform(i,e.clearcoatRoughnessMap),n.clearcoatRoughnessTexture=i}if(e.clearcoatNormalMap){let i={index:await r.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};e.clearcoatNormalScale.x!==1&&(i.scale=e.clearcoatNormalScale.x),r.applyTextureTransform(i,e.clearcoatNormalMap),n.clearcoatNormalTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Ue=class{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.dispersion===0)return;let r=this.writer.extensionsUsed,s={};s.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}},ve=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;let r=this.writer,s=r.extensionsUsed,n={};if(n.iridescenceFactor=e.iridescence,e.iridescenceMap){let i={index:await r.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};r.applyTextureTransform(i,e.iridescenceMap),n.iridescenceTexture=i}if(n.iridescenceIor=e.iridescenceIOR,n.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],n.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let i={index:await r.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};r.applyTextureTransform(i,e.iridescenceThicknessMap),n.iridescenceThicknessTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Ce=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;let r=this.writer,s=r.extensionsUsed,n={};if(n.transmissionFactor=e.transmission,e.transmissionMap){let i={index:await r.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};r.applyTextureTransform(i,e.transmissionMap),n.transmissionTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Fe=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;let r=this.writer,s=r.extensionsUsed,n={};if(n.thicknessFactor=e.thickness,e.thicknessMap){let i={index:await r.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};r.applyTextureTransform(i,e.thicknessMap),n.thicknessTexture=i}e.attenuationDistance!==1/0&&(n.attenuationDistance=e.attenuationDistance),n.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Oe=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;let r=this.writer.extensionsUsed,s={};s.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}},ke=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Te)&&!e.specularIntensityMap&&!e.specularColorMap)return;let r=this.writer,s=r.extensionsUsed,n={};if(e.specularIntensityMap){let i={index:await r.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};r.applyTextureTransform(i,e.specularIntensityMap),n.specularTexture=i}if(e.specularColorMap){let i={index:await r.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};r.applyTextureTransform(i,e.specularColorMap),n.specularColorTexture=i}n.specularFactor=e.specularIntensity,n.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},ze=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;let r=this.writer,s=r.extensionsUsed,n={};if(e.sheenRoughnessMap){let i={index:await r.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};r.applyTextureTransform(i,e.sheenRoughnessMap),n.sheenRoughnessTexture=i}if(e.sheenColorMap){let i={index:await r.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};r.applyTextureTransform(i,e.sheenColorMap),n.sheenColorTexture=i}n.sheenRoughnessFactor=e.sheenRoughness,n.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},De=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.anisotropy==0)return;let r=this.writer,s=r.extensionsUsed,n={};if(e.anisotropyMap){let i={index:await r.processTextureAsync(e.anisotropyMap)};r.applyTextureTransform(i,e.anisotropyMap),n.anisotropyTexture=i}n.anisotropyStrength=e.anisotropy,n.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Be=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;let r=this.writer.extensionsUsed,s={};s.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}},Pe=class{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||e.bumpScale===1&&!e.bumpMap)return;let r=this.writer,s=r.extensionsUsed,n={};if(e.bumpMap){let i={index:await r.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};r.applyTextureTransform(i,e.bumpMap),n.bumpTexture=i}n.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}},Ge=class{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let r=this.writer,s=e,n=new Float32Array(s.count*3),i=new Float32Array(s.count*4),a=new Float32Array(s.count*3),o=new J,l=new F,p=new ee,u=new F;for(let c=0;c<s.count;c++)s.getMatrixAt(c,o),o.decompose(l,p,u),l.toArray(n,c*3),p.toArray(i,c*4),u.toArray(a,c*3);let m={TRANSLATION:r.processAccessor(new N(n,3)),ROTATION:r.processAccessor(new N(i,4)),SCALE:r.processAccessor(new N(a,3))};s.instanceColor&&(m._COLOR_0=r.processAccessor(s.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:m},r.extensionsUsed[this.name]=!0,r.extensionsRequired[this.name]=!0}};G.Utils={insertKeyframe:function(e,t){let r=e.getValueSize(),s=new e.TimeBufferType(e.times.length+1),n=new e.ValueBufferType(e.values.length+r),i=e.createInterpolant(new e.ValueBufferType(r)),a;if(e.times.length===0){s[0]=t;for(let o=0;o<r;o++)n[o]=0;a=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<.001)return 0;s[0]=t,s.set(e.times,1),n.set(i.evaluate(t),0),n.set(e.values,r),a=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<.001)return e.times.length-1;s[s.length-1]=t,s.set(e.times,0),n.set(e.values,0),n.set(i.evaluate(t),e.values.length),a=s.length-1}else for(let o=0;o<e.times.length;o++){if(Math.abs(e.times[o]-t)<.001)return o;if(e.times[o]<t&&e.times[o+1]>t){s.set(e.times.slice(0,o+1),0),s[o+1]=t,s.set(e.times.slice(o+1),o+2),n.set(e.values.slice(0,(o+1)*r),0),n.set(i.evaluate(t),(o+1)*r),n.set(e.values.slice((o+1)*r),(o+2)*r),a=o+1;break}}return e.times=s,e.values=n,a},mergeMorphTargetTracks:function(e,t){let r=[],s={},n=e.tracks;for(let i=0;i<n.length;++i){let a=n[i],o=O.parseTrackName(a.name),l=O.findNode(t,o.nodeName);if(o.propertyName!=="morphTargetInfluences"||o.propertyIndex===void 0){r.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),a=a.clone(),a.setInterpolation(xe)}let p=l.morphTargetInfluences.length,u=l.morphTargetDictionary[o.propertyIndex];if(u===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+o.propertyIndex);let m;if(s[l.uuid]===void 0){m=a.clone();let h=new m.ValueBufferType(p*m.times.length);for(let d=0;d<m.times.length;d++)h[d*p+u]=m.values[d];m.name=(o.nodeName||"")+".morphTargetInfluences",m.values=h,s[l.uuid]=m,r.push(m);continue}let c=a.createInterpolant(new a.ValueBufferType(1));m=s[l.uuid];for(let h=0;h<m.times.length;h++)m.values[h*p+u]=c.evaluate(m.times[h]);for(let h=0;h<a.times.length;h++){let d=this.insertKeyframe(m,a.times[h]);m.values[d*p+u]=a.values[h]}}return e.tracks=r,e},toFloat32BufferAttribute:function(e){let t=new N(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let r=0,s=e.count;r<s;r++)for(let n=0;n<e.itemSize;n++)t.setComponent(r,n,e.getComponent(r,n));return t}};export{G as GLTFExporter};
